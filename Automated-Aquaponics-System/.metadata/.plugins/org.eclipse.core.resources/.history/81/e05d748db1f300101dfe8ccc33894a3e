#include "first_convey.h"
#include "sensor.h"
#include <stdio.h>

static TIM_HandleTypeDef *s_htim = NULL;
static uint32_t s_ch = TIM_CHANNEL_1;

static GPIO_TypeDef *s_dir_port = NULL;
static uint16_t s_dir_pin = 0;

static GPIO_TypeDef *s_en_port = NULL;
static uint16_t s_en_pin = 0;

static UART_HandleTypeDef *s_uart = NULL;

static ConveyorState s_state = CONVEYOR_RUN;
static bool s_motor_running = false;

static uint32_t TIM3_GetClockHz(void)
{
  // TIM3 기준(APB1) : 지금 네 프로젝트가 TIM3라서 이대로 두는 게 안전
  uint32_t pclk1 = HAL_RCC_GetPCLK1Freq();
  if ((RCC->CFGR & RCC_CFGR_PPRE1) != RCC_CFGR_PPRE1_DIV1) return pclk1 * 2;
  return pclk1;
}

static void StepPWM_SetHz(uint32_t hz)
{
  if (hz < 1) hz = 1;
  uint32_t tim_clk = TIM3_GetClockHz();
  uint32_t arr = (tim_clk / hz) - 1;
  if (arr > 0xFFFF) arr = 0xFFFF;

  __HAL_TIM_SET_PRESCALER(s_htim, 0);
  __HAL_TIM_SET_AUTORELOAD(s_htim, arr);
  __HAL_TIM_SET_COMPARE(s_htim, s_ch, arr / 2);
  __HAL_TIM_SET_COUNTER(s_htim, 0);
}

static void Motor_SetDir(bool dir)
{
  HAL_GPIO_WritePin(s_dir_port, s_dir_pin, dir ? GPIO_PIN_SET : GPIO_PIN_RESET);
}

static void Motor_Enable(bool en)
{
  HAL_GPIO_WritePin(s_en_port, s_en_pin, en ? GPIO_PIN_SET : GPIO_PIN_RESET);
}

static void Motor_Start(uint32_t step_hz)
{
  StepPWM_SetHz(step_hz);
  HAL_TIM_PWM_Start(s_htim, s_ch);
}

static void Motor_Stop(void)
{
  HAL_TIM_PWM_Stop(s_htim, s_ch);
}

void FirstConvey_Init(TIM_HandleTypeDef *htim_step, uint32_t tim_ch,
                      GPIO_TypeDef *dir_port, uint16_t dir_pin,
                      GPIO_TypeDef *en_port,  uint16_t en_pin,
                      UART_HandleTypeDef *huart)
{
  s_htim = htim_step;
  s_ch = tim_ch;

  s_dir_port = dir_port; s_dir_pin = dir_pin;
  s_en_port  = en_port;  s_en_pin  = en_pin;

  s_uart = huart;

  s_state = CONVEYOR_RUN;
  s_motor_running = false;
}

void FirstConvey_SetState(ConveyorState s) { s_state = s; }
ConveyorState FirstConvey_GetState(void)   { return s_state; }

static void Conveyor_Run(void)
{
  if (!s_motor_running)
  {
    Motor_SetDir(true);
    Motor_Enable(true);
    Motor_Start(2000);
    s_motor_running = true;
  }

  if (Sensor_IR_Detected())
  {
    Motor_Stop();
    Motor_Enable(false);
    s_motor_running = false;
    s_state = CONVEYOR_STOP;
  }
}

static void Conveyor_Stop(void)
{
  uint16_t raw = Sensor_DMS80_ReadRawAvg(16);
  uint32_t mv = (3300UL * raw) / 4095UL;
  float v  = (3.3f * raw) / 4095.0f;
  float cm = Sensor_DMS80_VoltageToCm(v);

  char buf[80];
  int cm10 = (int)(cm * 10.0f);
  int len = snprintf(buf, sizeof(buf),
                     "raw=%u, %lumV, cm=%d.%d\r\n",
                     raw, mv, cm10/10, cm10%10);

  HAL_UART_Transmit(s_uart, (uint8_t*)buf, len, 100);
  HAL_Delay(500); // 나중에 논블로킹으로 바꿔도 됨
}

void FirstConvey_Task(void)
{
  if (s_state == CONVEYOR_RUN)  Conveyor_Run();
  else                          Conveyor_Stop();
}
